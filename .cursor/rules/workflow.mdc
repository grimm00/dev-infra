---
alwaysApply: true
---

# Workflow Rules

**Purpose:** Development workflow processes and commands for dev-infra  
**Last Updated:** 2025-12-15  
**Status:** ‚úÖ Active

---

## üìã Quick Links

- **[Main Rules](main.mdc)** - Core project rules and standards
- **[Template Rules](template.mdc)** - Template-specific standards
- **[Worktree Workflow](../../docs/WORKTREE-WORKFLOW.md)** - Feature development with worktrees and draft PRs

---

## üöÄ Git Flow Workflow

### Branch Strategy

**ALWAYS follow this branching model:**

- `main` - Production releases ONLY (protected)
- `develop` - Ongoing development (protected)
- `feat/*` - Feature branches (e.g., `feat/new-template-type`)
- `fix/*` - Bug fixes (e.g., `fix/generator-script-bug`)
- `docs/*` - Documentation updates
- `chore/*` - Maintenance tasks
- `ci/*` - CI/CD changes
- `release/*` - Release preparation branches

### Commit Requirements

1. **Feature/Fix/CI Branches**

   - REQUIRE pull requests to develop/main
   - Full testing and linting required
   - External reviews on release branches
   - Use conventional commits format

2. **Documentation/Chore Branches**

   - CAN push directly to develop/main
   - Minimal validation required
   - Focus on clarity and accuracy

3. **Commit Message Format**

   ```
   type(scope): brief description

   Longer explanation if needed
   ```

   Types: feat, fix, docs, chore, test, refactor, ci

   Examples:

   - `feat(templates): add CLI project template type`
   - `fix(scripts): handle spaces in project names`
   - `docs(planning): add command integration planning`
   - `chore(ci): update Docker test image`

---

## üëÄ Review-then-Commit Workflow

**Essential for agentic coding.** Forces a human review pause between AI-generated changes and committing them.

**Commands:** `/review` + `/commit`

### Flow

```
[AI makes changes]
    ‚Üì
/review [description]     ‚Üê Stage, capture diff + summary, draft message, STOP
    ‚Üì human review        ‚Üê KEY PAUSE: review diff, verify changes, refine message
/commit                   ‚Üê Commit with reviewed message, clean up artifacts
```

### Why This Matters

With AI-assisted development, it's too easy to commit code you haven't actually reviewed. The `/review` command:
- Stages files and captures a diff + human-readable summary
- Drafts a conventional commit message
- **Stops and waits** for human approval

The `/commit` command reads the draft message from the review session and finalizes.

### When to Use

- After any AI implementation (`/task`, `/spike`, etc.)
- When AI modifies multiple files and you want to verify scope
- Any time you want a deliberate review pause before committing

**See:** `.cursor/commands/review.md` and `.cursor/commands/commit.md` for complete documentation

---

## üîç Pull Request Review Workflow

### NEVER Merge Without Review

**CRITICAL:** Do NOT merge pull requests automatically. Always follow this workflow:

1. **Create PR** - Use `/pr --phase [N]` or `/pr --fix [batch]` command (when available)
2. **Stop and Wait** - Present PR link to user, do NOT proceed to merge
3. **External Review** - User will run `dt-review` (or use `/pr-validation` when available)
   - **Note:** Missing reviews are acceptable - workflow continues without review
4. **Sourcery Feedback** - Reviews saved to `admin/feedback/sourcery/pr##.md` (if applicable)
   - **Note:** Missing reviews are acceptable - workflow continues without review
5. **Priority Assessment** - Fill out priority matrix in Sourcery review file (if review available)
6. **Fix Planning** - Use `/fix-plan` to create fix plans (when applicable)
7. **Status Validation** - Verify status updates are included in PR (see Status Check Checklist below)
   - **Note:** Status updates are mandatory but validation is lenient (warnings, not blockers) to start
8. **User Approval** - Only merge after user explicitly approves
9. **Post-Merge** - Use `/post-pr` to update documentation (when available)
   - **Note:** `/post-pr` automatically updates phase and feature status after PR merge

### Status Check Checklist

**Before PR Approval, verify status updates:**

- [ ] Phase document status is current
  - Location: `docs/maintainers/planning/features/[feature-name]/phase-N.md` or `docs/maintainers/planning/phases/phase-N.md`
  - Verify: Status reflects actual completion state
  - Expected: `**Status:** ‚úÖ Complete` (if phase is complete)
- [ ] Feature status document is current (if applicable)
  - Location: `docs/maintainers/planning/features/[feature-name]/status-and-next-steps.md`
  - Verify: Phase marked appropriately, progress updated
- [ ] Status updates are included in PR commits
  - Verify: Status document changes are committed
  - Verify: Status updates match actual work completed
- [ ] Progress tracking is accurate
  - Verify: Progress percentages reflect actual completion
  - Verify: Task checkboxes match completed work

**Status Update Requirements:**

- **Mandatory:** Status updates are required for PR approval
- **Lenient Approach:** Validation uses warnings, not blockers (to start)
- **During Work:** Status should be updated during work (per `/task` workflow)
- **Before PR:** Status must be current before PR creation (per `/pr` command validation)
- **After Merge:** Status automatically updated by `/post-pr` command

**If Status Not Current:**

- ‚ö†Ô∏è **Warning:** Status documents may be outdated
- ‚ö†Ô∏è **Recommendation:** Update status documents before PR approval
- ‚ö†Ô∏è **Note:** This is a warning, not a blocker - PR can proceed but status should be updated
- Document the warning in PR review
- Suggest updating status documents

**See Also:**

- [Status Update Workflow](../../docs/STATUS-UPDATE-WORKFLOW.md) - Complete status update guide
- [Status Update Checklist](../../docs/STATUS-UPDATE-CHECKLIST.md) - Checklist for status updates
- [Status Validation](../commands/pr.md#status-validation) - Status validation in `/pr` command

### Priority Matrix Assessment

For each Sourcery comment, assess:

- **Priority:** CRITICAL üî¥ / HIGH üü† / MEDIUM üü° / LOW üü¢
- **Impact:** CRITICAL üî¥ / HIGH üü† / MEDIUM üü° / LOW üü¢
- **Effort:** LOW üü¢ / MEDIUM üü° / HIGH üü† / VERY_HIGH üî¥

---

## üìä Template Development Process

### Creating New Template Features

**ALWAYS follow this structure when creating template features:**

1. **Create Feature Directory**

   ```
   admin/planning/features/[feature-name]/
   ```

2. **Required Files**

   - `README.md` - Feature hub with quick links
   - `implementation-plan.md` - Task index with YAML frontmatter and GFM checkboxes
   - `status-and-next-steps.md` - Current progress tracking
   - `tasks/` directory with group files (e.g., `01-foundation.md`)

3. **Implementation Plan Structure**

   ```markdown
   ---
   task_count: 8
   groups:
     - name: "Foundation"
       file: "tasks/01-foundation.md"
       tasks: [1, 2, 3]
   tasks_files:
     - "tasks/01-foundation.md"
   ---
   # Implementation Plan - [Feature Name]

   **Status:** [Status Indicator]
   **Created:** [YYYY-MM-DD]

   ## üìã Overview

   [Template feature description]

   ## üìù Implementation Plan

   ### Foundation
   - [ ] Task 1: [Description]
   - [ ] Task 2: [Description]

   ## ‚úÖ Definition of Done

   - [ ] All tasks complete
   ```

### Template Development Lifecycle

1. **Discovery** - Identify opportunity from real projects
2. **Planning** - Write `implementation-plan.md`, break into task groups
3. **Implementation** - Execute tasks with `/task`, update templates
4. **Testing** - Test template generation
5. **Documentation** - Update user docs and examples
6. **Release** - Include in next release

---

## üîÑ CI/CD Integration

### Testing Requirements

- **Feature branches:** Full test suite, template validation, linting
- **Documentation branches:** Markdown validation only
- **Release branches:** Full validation + external reviews
- **CI branches:** Full validation + workflow testing

### Template Validation

**Before committing template changes:**

```bash
# Test template generation
./scripts/new-project.sh

# Validate templates
./scripts/validate-templates.sh
```

**Validation Checklist:**

- [ ] Template generates successfully
- [ ] All required directories created
- [ ] All README.md files present
- [ ] Documentation links work
- [ ] No broken references

---

## üîó Command Integration Workflow

### Core Commands (Complete)

**All core workflow commands are now implemented and tested:**

- `/fix-plan` - ‚úÖ Create fix batches from reviews
- `/fix-implement` - ‚úÖ Implement fix batches
- `/task` - ‚úÖ Task implementation with TDD (replaces `/task-phase`)
- `/pr` - ‚úÖ Centralized PR creation
- `/pr-validation` - ‚úÖ PR validation workflow
- `/post-pr` - ‚úÖ Post-merge documentation
- `/plan-review` - ‚úÖ Review implementation plans before work (replaces `/pre-phase-review`)
- `/address-review` - ‚úÖ Address gaps from plan review

**See:** `.cursor/commands/` for all command documentation

---

## üîÑ Plan Review Workflow

**Best Practice:** Review implementation plans before starting work to catch issues early.

**Workflow:**

```
/plan-review [feature]
    ‚Üí Identifies gaps, clarifications needed
    ‚Üí Creates review document

/address-review [review-path]
    ‚Üí Updates plan with recommendations
    ‚Üí Commits documentation changes only

/task next
    ‚Üí Implements tasks with TDD
    ‚Üí Clean commits, separate from planning
```

**Benefits:**

- Catch clarifications before implementation (saves time)
- Separate planning updates from implementation commits
- Better estimation accuracy
- Cleaner git history

---

## üß™ Spike Workflow

**A spike is a time-boxed experiment to answer "can it work?" before committing to implementation.**

**Command:** `/spike [topic] [options]`

### When to Spike vs Research

| Situation | Use Spike | Use Research |
|-----------|-----------|--------------|
| Technical uncertainty ("can it even work?") | Yes | |
| Architectural decision with high commitment | Yes | |
| Need to test against a real environment | Yes | |
| Comparing well-documented options | | Yes |
| Investigating best practices | | Yes |
| Low-risk, well-understood path | | Yes |

### Spike Determination Framework

During exploration, assess each topic:

| Risk Level | Determination | Rationale |
|------------|---------------|-----------|
| HIGH | **Spike first** | Hard to pivot once committed |
| MEDIUM-HIGH | **Consider spike** | Benefits from hands-on validation |
| MEDIUM | Research only | Depends on other decisions |
| LOW | Research only | Clear path, low risk |

### Integration with Explore ‚Üí Research ‚Üí Decision

```
/explore [topic]           ‚Üê Identifies spike candidates (spike determination table)
    |
/spike [topic]             ‚Üê Validate high-risk assumptions (2-4 hours)
    |                        (optional, when technical uncertainty is high)
    |
/research --from-explore   ‚Üê Investigate remaining questions
    |                        (spike learnings inform research)
    |
/decision --from-research  ‚Üê Make decisions (spike-backed = HIGH confidence)
```

### Key Principles

- **Time-boxed:** 2-4 hours maximum
- **Throwaway mindset:** Code may be discarded
- **Learning-focused:** Output is knowledge, not production code
- **Question-driven:** Define success criteria before starting
- **Document regardless:** Capture learnings even if time expires

**See:** `.cursor/commands/spike.md` for complete command documentation

---

## üå≥ Worktree Feature Workflow

**For feature development using git worktrees and draft PRs.**

**Full Guide:** [WORKTREE-WORKFLOW.md](../../docs/WORKTREE-WORKFLOW.md)

### Quick Reference

**Setup:**
```bash
# Create worktree for feature
git worktree add worktrees/feat-my-feature -b feat/my-feature

# Open in Cursor
cursor worktrees/feat-my-feature
```

**Naming Convention:** Directory mirrors branch name (`feat/foo` ‚Üí `worktrees/feat-foo`)

### Draft PR Workflow

```
1. First meaningful commit ‚Üí Push ‚Üí Open Draft PR
2. Phase 1 work ‚Üí Push ‚Üí /pr --review
3. Fix Sourcery issues ‚Üê KEY STEP
4. Phase 2 work ‚Üí Push ‚Üí /pr --review
5. Fix Sourcery issues
6. ... repeat ...
7. Mark ready for review ‚Üí Final review ‚Üí Merge
```

**Commands:**
- `/pr --draft` - Create draft PR for early feedback
- `/pr --review` - Request Sourcery review (manual trigger required for drafts)
- `/pr --ready` - Mark draft PR as ready for final review

### Fix Before Re-Review Pattern

**Critical:** Sourcery reviews the **entire PR diff** each time. Fix issues before requesting next review to avoid duplicate comments.

**Why this matters:**
- Each review sees all changes since branch divergence
- Unfixed issues generate duplicate comments
- This discipline keeps review history clean

### PR Count Reduction

| Workflow | PRs per Feature |
|----------|-----------------|
| Old (phase PRs) | ~3-5 PRs |
| **New (draft PR)** | **1 PR** |

### Self-Contained Branches

**All feature content stays on feature branch:**
- Explorations (`admin/explorations/[feature]/`)
- Research (`admin/research/[feature]/`)
- Decisions (`admin/decisions/[feature]/`)
- Planning (`admin/planning/features/[feature]/`)

**Benefits:**
- Feature is portable and atomic
- No cleanup on develop if abandoned
- All context merges together

### Sourcery Configuration

Create `.sourcery.yaml` to ignore process documentation:

```yaml
ignore:
  - admin/**     # Process docs
  - tmp/**       # Temporary files
```

**Related ADRs:**
- [ADR-001: Worktree Location](../../admin/decisions/worktree-feature-workflow/adr-001-worktree-location-and-naming.md)
- [ADR-002: Self-Contained Branches](../../admin/decisions/worktree-feature-workflow/adr-002-self-contained-feature-branches.md)
- [ADR-003: Draft PR Workflow](../../admin/decisions/worktree-feature-workflow/adr-003-draft-pr-review-workflow.md)
- [ADR-004: Sourcery Configuration](../../admin/decisions/worktree-feature-workflow/adr-004-sourcery-configuration.md)

---

## üß™ TDD for Bash Scripts

**Pattern:** Use RED-GREEN-REFACTOR cycle for shell scripts.

**Framework:** Bats (Bash Automated Testing System)

**Workflow:**

1. **RED:** Write failing test first

   ```bash
   @test "script generates assessment file" {
       run "$SCRIPT" v0.4.0 --generate
       [ "$status" -eq 0 ]
       [[ "$output" =~ "Overall Readiness" ]]
   }
   ```

2. **GREEN:** Implement minimum code to pass
3. **REFACTOR:** Clean up while tests pass

**Test Location:** `tests/unit/[script-name].bats`

**Running Tests:**

```bash
bats tests/unit/[script-name].bats
```

**Evidence:**

- Release Readiness feature: 48 tests across 3 scripts
- Experimental Template: 18+ tests for generator and drift detection

**Best Practices (from fix-management-workflow learnings):**

- Use `bash "$SCRIPT"` not `source "$SCRIPT"` - `source` causes `exit` to terminate test runner
- Use specific assertions (exact phrases, not keywords) - prevents false positives
- Document shared fixtures clearly - tests should not depend on undocumented setup
- Add setup verification step to tests for shared fixtures

---

## üö© Script Flag Conventions

**Standard flags for all scripts:**

| Flag         | Purpose                                 | Example                                        |
| ------------ | --------------------------------------- | ---------------------------------------------- |
| `--dry-run`  | Show what would happen without doing it | `create-release-branch.sh v0.4.0 --dry-run`    |
| `--force`    | Override blocking checks                | `/pr --release --force`                        |
| `--verbose`  | Show detailed output                    | `analyze-releases.sh --verbose`                |
| `--json`     | Output in JSON format                   | `analyze-releases.sh --json`                   |
| `--generate` | Generate output file                    | `check-release-readiness.sh v0.4.0 --generate` |
| `--help`     | Show usage information                  | `create-release-branch.sh --help`              |

**Key Principles:**

- `--dry-run` for any state-modifying operation
- `--force` requires justification in commit/PR
- `--generate` transforms validation into documentation
- All flags after version/required arguments

---

## üìù Release Process

### Standard Release Workflow

**Phase 1: Feature Development (on develop)**

- Develop features on `develop` branch
- Create feature branches from `develop`
- Merge features to `develop` after review
- Accumulate features over time

**Phase 2: Release Preparation**

**Step 1: Assess Readiness**

```bash
# Check release readiness
./scripts/check-release-readiness.sh v0.4.0

# Generate assessment document
./scripts/check-release-readiness.sh v0.4.0 --generate > admin/planning/releases/v0.4.0/RELEASE-READINESS.md
```

**Step 2: Create Release Branch**

```bash
# Creates branch + initial assessment
./scripts/create-release-branch.sh v0.4.0
```

**Step 3: On release/vX.Y.Z branch:**

- Update CHANGELOG version
- Update version numbers in files
- Create release notes
- Fix critical bugs found in testing
- **Do not** add new features

**Phase 3: Release Distribution**

- Merge release branch to `main`
- Create GitHub release
- Tag release version
- Distribution workflow runs automatically

**Phase 4: Post-Release**

```bash
# Update historical tracking
./scripts/analyze-releases.sh --last 5
```

**See:** `admin/planning/releases/PROCESS.md` for complete process

---

## üéØ Template Maintenance Guidelines

### When Modifying Templates

1. **Test First**

   - Always test with `./scripts/new-project.sh`
   - Verify generated project structure
   - Check all links and navigation

2. **Update Documentation**

   - Update template README files
   - Update user documentation in `docs/`
   - Update planning documents if feature-related

3. **Maintain Consistency**
   - Follow existing template patterns
   - Keep structure consistent across template types
   - Preserve proven patterns from real projects

### Template Versioning

- Templates evolve based on real project learnings
- Capture learnings in `admin/planning/opportunities/`
- Apply improvements in planned releases
- Document changes in CHANGELOG.md

---

## üîç CI/CD Failure Investigation Best Practices

### Comprehensive Root Cause Analysis

**When investigating CI/CD failures:**

1. **Check All Similar Patterns**

   - Don't stop at the first issue found
   - Look for similar directories, files, or patterns
   - Check test failures for patterns (e.g., multiple stage directories)
   - Verify fix addresses all similar issues

2. **PR Validation Value**

   - PR validation workflow (`/pr-validation`) is valuable for catching issues before merge
   - CI environment may expose issues not visible locally
   - Different test execution order may reveal additional failures
   - Systematic validation catches edge cases

3. **Workflow File Investigation**
   - Always investigate workflow files when CI failures occur
   - Check `.github/workflows/` files for configuration issues
   - Verify Docker/test environment setup
   - Even if root cause seems clear, verify workflow files are correct

**Example:** PR #31 fix discovered that `stage1-topic`, `stage2-topic`, and `stage3-topic` all had the same empty directory issue, not just the one causing immediate failures.

**See:** `admin/planning/notes/chat-log-2025-12-08-pr31-fix-implementation.md` for complete example

---

## üîó Related

- **Main Rules:** [main.mdc](main.mdc) - Core project rules and standards
- **Template Rules:** [template.mdc](template.mdc) - Template-specific standards
- **Command Documentation:** `.cursor/commands/` - Detailed command workflows
- **Release Process:** `admin/planning/releases/PROCESS.md`

---

**Last Updated:** 2025-12-15  
**Status:** ‚úÖ Active  
**Next:** v0.6.0 release (Experimental Template)
