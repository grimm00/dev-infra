# Sourcery Review Analysis
**PR**: #45
**Repository**: grimm00/dev-infra
**Generated**: Fri Dec 12 08:46:38 CST 2025

---

## Summary

Total Individual Comments: 6 + Overall Comments

## Individual Comments

### Comment #1

**Location**: `scripts/update-version-references.sh:305-306`

**Type**: issue (bug_risk)

**Description**: In `update_file_version`, the presence check uses `grep -q "$old_version"`, but for `package.json` this is a v-prefixed value (e.g., `v0.4.0`) while the file stores the bare SemVer (e.g., `0.4.0`). That means the grep fails and the function returns early, so `package.json` is never updated. Consider either special-casing `package.json` to search for `get_version_number "$old_version"`, or moving the presence check into the per-file-type branches so each can use the appropriate version format.

<details>
<summary>Details</summary>

<b>Code Context</b>

<pre><code>
+    
+    # 3. Update package.json (if exists)
+    # Pattern: &quot;version&quot;: &quot;X.Y.Z&quot; (no &#x27;v&#x27; prefix)
+    if [[ -f &quot;$PROJECT_ROOT/package.json&quot; ]]; then
+        if ! update_file_version &quot;$PROJECT_ROOT/package.json&quot; &quot;$OLD_VERSION&quot; &quot;$NEW_VERSION&quot; &quot;package.json&quot;; then
+            ((errors++))
+        fi
</code></pre>

<b>Issue</b>

**issue (bug_risk):** package.json update uses the v-prefixed version for detection, so the replacement likely never runs

</details>

---

### Comment #2

**Location**: `tests/unit/update-version-references.bats:223-232`

**Type**: Version

**Description**: These tests currently only create files and assert their existence; they never call `update-version-references.sh` (the `run "$SCRIPT"...` lines are still TODOs), so they don‚Äôt verify the advertised update/validation behavior.

<details>
<summary>Details</summary>

<b>Code Context</b>

<pre><code>
+# Task 2: File Update Functionality (RED Phase - Tests First)
+# ============================================================================
+
+@test &quot;update-version-references.sh updates .cursor/rules/main.mdc version pattern&quot; {
+    # Create temporary test file with version pattern
+    TEST_FILE=&quot;$BATS_TEST_TMPDIR/test-main.mdc&quot;
+    echo &quot;**Version:** v0.4.0 (released 2025-12-11)&quot; &gt; &quot;$TEST_FILE&quot;
+    
+    # Run script on test file (would need script to accept file list or use test file)
+    # For now, verify test file exists and has expected pattern
+    [ -f &quot;$TEST_FILE&quot; ]
+    grep -q &quot;v0.4.0&quot; &quot;$TEST_FILE&quot;
+    
+    # TODO: When Task 2 is implemented, test actual update:
+    # run &quot;$SCRIPT&quot; --old-version v0.4.0 --new-version v0.5.0 --files &quot;$TEST_FILE&quot;
+    # grep -q &quot;v0.5.0&quot; &quot;$TEST_FILE&quot;
</code></pre>

<b>Issue</b>

**issue (testing):** This test (and a few others in Task 2/3) are placeholders and don&#x27;t actually exercise the script&#x27;s update logic yet.

</details>

---

### Comment #3

**Location**: `tests/unit/update-version-references.bats:81-84`

**Type**: suggestion (testing)

**Description**: Several tests currently accept both exit codes 0 and 1 for valid invocations (e.g. the version and flag acceptance tests). Now that the script behavior is defined, these should assert the *specific* expected status so regressions (like valid calls starting to fail) are caught.

<details>
<summary>Details</summary>

<b>Code Context</b>

<pre><code>
+# Task 1: Version Format Validation
+# ============================================================================
+
+@test &quot;update-version-references.sh accepts valid version formats&quot; {
+    run &quot;$SCRIPT&quot; --old-version v0.4.0 --new-version v0.5.0
+    # Should accept valid versions (may not update files yet, but should validate)
+    [ &quot;$status&quot; -eq 0 ] || [ &quot;$status&quot; -eq 1 ]
+    # If status is 1, it should be because files don&#x27;t exist yet, not version format
+    if [ &quot;$status&quot; -eq 1 ]; then
</code></pre>

<b>Issue</b>

**suggestion (testing):** Allowing either exit status 0 or 1 in several tests weakens the guarantees around expected behavior.

</details>

---

### Comment #4

**Location**: `tests/unit/update-version-references.bats:251-234`

**Type**: Version

**Description**: The PR calls out "Backup and restore on failure" / "rollback on failure", but current tests only sketch backup creation (and even that is a TODO) and don‚Äôt exercise rollback behavior.

<details>
<summary>Details</summary>

<b>Code Context</b>

<pre><code>
+    # After update, should have: &quot;**Version:** v0.5.0 (released 2025-12-11)&quot;
+}
+
+@test &quot;update-version-references.sh creates backup before modification&quot; {
+    # Test that backup file (.bak) is created before modifying original
+    TEST_FILE=&quot;$BATS_TEST_TMPDIR/test-backup.mdc&quot;
+    echo &quot;**Version:** v0.4.0&quot; &gt; &quot;$TEST_FILE&quot;
+    
+    # TODO: When Task 2 is implemented:
+    # run &quot;$SCRIPT&quot; --old-version v0.4.0 --new-version v0.5.0 --files &quot;$TEST_FILE&quot;
+    # [ -f &quot;${TEST_FILE}.bak&quot; ]
+    # grep -q &quot;v0.4.0&quot; &quot;${TEST_FILE}.bak&quot;  # Backup should have old content
</code></pre>

<b>Issue</b>

**suggestion (testing):** There are no tests covering rollback/restore behavior when an update fails, despite it being a key feature.

</details>

---

### Comment #5

**Location**: `tests/unit/update-version-references.bats:385-336`

**Type**: suggestion (testing)

**Description**: Several dry-run tests (e.g. `dry-run shows matching lines`, `dry-run shows file-by-file preview`, and some validation tests) assert behavior based on the real repo files (like `$PROJECT_ROOT/.cursor/rules/main.mdc`) containing `v0.4.0`. This couples test outcomes to the current repo state and release version, making them brittle.

<details>
<summary>Details</summary>

<b>Code Context</b>

<pre><code>
+    [ &quot;$ORIGINAL_CONTENT&quot; = &quot;$CURRENT_CONTENT&quot; ]
+}
+
+@test &quot;update-version-references.sh dry-run shows matching lines&quot; {
+    # Test that dry-run shows where matches are found
+    run &quot;$SCRIPT&quot; --dry-run --old-version v0.4.0 --new-version v0.5.0
+    [ &quot;$status&quot; -eq 0 ]
+    
+    # If main.mdc has v0.4.0, should show matches
+    if [ -f &quot;$PROJECT_ROOT/.cursor/rules/main.mdc&quot; ]; then
+        if grep -q &quot;v0.4.0&quot; &quot;$PROJECT_ROOT/.cursor/rules/main.mdc&quot;; then
+            [[ &quot;$output&quot; =~ &quot;Matches found&quot; || &quot;$output&quot; =~ &quot;matches&quot; ]]
+        fi
</code></pre>

<b>Issue</b>

**suggestion (testing):** Several dry-run tests depend on the real repo files and specific version contents, which may make the suite brittle and environment-dependent.

</details>

---

### Comment #6

**Location**: `docs/VERSION-REFERENCES.md:19`

**Type**: Pattern

**Description**: This section is the only place using `cursor/rules/main.mdc`; other references (e.g., in phase-2.md and `.cursor/commands/release-finalize.md`) use `.cursor/rules/main.mdc`. Please update this heading to match the dotted path for consistency and correctness.

<details>
<summary>Details</summary>

<b>Code Context</b>

<pre><code>
+
+## üìç Version Reference Locations
+
+### 1. Cursor Rules (`cursor/rules/main.mdc`)
+
+**Pattern:** `**Version:** vX.Y.Z`
</code></pre>

<b>Issue</b>

**issue (typo):** The Cursor Rules file path here is missing the leading dot, which is present in other references (use `.cursor/rules/main.mdc`).

<b>Suggestion</b>

<pre><code>
### 1. Cursor Rules (`.cursor/rules/main.mdc`)
</code></pre>

</details>

---

## Overall Comments

- The `update_file_version` logic for `package.json` first checks `grep -q "$old_version"` (with the `v` prefix) before updating, but `package.json` stores the version without `v`, so the check will always fail and the file will never be updated; consider normalizing to the numeric form (e.g., via `get_version_number`) consistently for both the grep check and the sed replacement.
- The argument parser currently allows a flag to be consumed as the value of `--old-version`/`--new-version` (as noted in the tests); if you want to make the CLI more robust, add an explicit check that the next token does not start with `--` before treating it as a value and emit a clearer error when it does.

## Priority Matrix Assessment

| Comment | Priority | Impact | Effort | Action | Notes |
|---------|----------|--------|--------|--------|-------|
| #1 | üî¥ **CRITICAL** | üî¥ **CRITICAL** | üü° **MEDIUM** | **Fix now** | Bug: package.json never updated due to v-prefix mismatch in grep check |
| #2 | üü° **MEDIUM** | üü° **MEDIUM** | üü† **HIGH** | **Defer** | Tests are placeholders (TODOs), but script works. Need proper integration tests |
| #3 | üü° **MEDIUM** | üü° **MEDIUM** | üü¢ **LOW** | **Defer** | Tests accept 0 or 1 exit codes - should be more specific |
| #4 | üü° **MEDIUM** | üü° **MEDIUM** | üü° **MEDIUM** | **Defer** | Missing rollback/restore tests - feature exists but not tested |
| #5 | üü° **MEDIUM** | üü° **MEDIUM** | üü° **MEDIUM** | **Defer** | Tests depend on real repo state (v0.4.0) - brittle |
| #6 | üü¢ **LOW** | üü¢ **LOW** | üü¢ **LOW** | **Fix now** | Typo: Missing dot in path (`cursor/rules` ‚Üí `.cursor/rules`) |
| Overall-#1 | üî¥ **CRITICAL** | üî¥ **CRITICAL** | üü° **MEDIUM** | **Fix now** | Same as #1 - package.json v-prefix issue |
| Overall-#2 | üü° **MEDIUM** | üü° **MEDIUM** | üü¢ **LOW** | **Defer** | Argument parser allows flags as values - minor robustness issue |

### Summary

**CRITICAL Issues (Fix Now):**
- **#1 / Overall-#1:** package.json update bug - grep check uses v-prefix but file has bare semver
  - **Impact:** package.json will never be updated by script (core functionality broken)
  - **Effort:** Medium - need to normalize version format in grep check
  - **Fix:** Use `get_version_number` for package.json presence check

**LOW Issues (Fix Now):**
- **#6:** Documentation typo - missing dot in path
  - **Impact:** Minor documentation inconsistency
  - **Effort:** Low - simple find/replace
  - **Fix:** Change `cursor/rules/main.mdc` to `.cursor/rules/main.mdc`

**MEDIUM Issues (Defer to Future PR):**
- **#2:** Placeholder tests (TODOs) - tests exist but don't exercise update logic
- **#3:** Test exit codes too permissive - should assert specific expected status
- **#4:** Missing rollback/restore tests - feature exists but not tested
- **#5:** Tests depend on real repo state - brittle, environment-dependent
- **Overall-#2:** Argument parser robustness - allows flags as values

### Priority Levels
- üî¥ **CRITICAL**: Security, stability, or core functionality issues
- üü† **HIGH**: Bug risks or significant maintainability issues
- üü° **MEDIUM**: Code quality and maintainability improvements
- üü¢ **LOW**: Nice-to-have improvements

### Impact Levels
- üî¥ **CRITICAL**: Affects core functionality
- üü† **HIGH**: User-facing or significant changes
- üü° **MEDIUM**: Developer experience improvements
- üü¢ **LOW**: Minor improvements

### Effort Levels
- üü¢ **LOW**: Simple, quick changes
- üü° **MEDIUM**: Moderate complexity
- üü† **HIGH**: Complex refactoring
- üî¥ **VERY_HIGH**: Major rewrites


