---
name: Continuous Integration

on:
  push:
    branches:
      - main
      - develop
      - "feat/*"
      - "fix/*"
      - "chore/*"
      - "docs/*"
      - "ci/*"
      - "release/*"
    paths-ignore:
      - "admin/**"
      - "docs/**"
      - "*.md"
      - "LICENSE"
      - ".gitignore"
  pull_request:
    branches:
      - main
      - develop
    paths-ignore:
      - "admin/**"
      - "docs/**"
      - "*.md"
      - "LICENSE"
      - ".gitignore"

permissions:
  contents: read
  security-events: write

jobs:
  detect-branch-type:
    runs-on: ubuntu-latest
    name: Detect Branch Type
    outputs:
      branch-type: ${{ steps.detect.outputs.type }}
      needs-lint: ${{ steps.detect.outputs.needs-lint }}
      needs-test: ${{ steps.detect.outputs.needs-test }}
      needs-install: ${{ steps.detect.outputs.needs-install }}
      needs-external-reviews: ${{ steps.detect.outputs.needs-external-reviews }}

    steps:
      - name: Detect branch type and requirements
        id: detect
        run: |
          # Differentiate between push and pull_request events
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BRANCH_NAME="${{ github.head_ref }}"
          else
            BRANCH_NAME="${{ github.ref_name }}"
          fi

          echo "Event: ${{ github.event_name }}"
          echo "Branch: $BRANCH_NAME"

          # Default values
          echo "type=unknown" >> $GITHUB_OUTPUT
          echo "needs-lint=false" >> $GITHUB_OUTPUT
          echo "needs-test=false" >> $GITHUB_OUTPUT
          echo "needs-install=false" >> $GITHUB_OUTPUT
          echo "needs-external-reviews=false" >> $GITHUB_OUTPUT

          # Feature branches
          if [[ "$BRANCH_NAME" =~ ^feat/ ]]; then
            echo "type=feature" >> $GITHUB_OUTPUT
            echo "needs-lint=true" >> $GITHUB_OUTPUT
            echo "needs-test=true" >> $GITHUB_OUTPUT
            echo "needs-install=true" >> $GITHUB_OUTPUT
            echo "needs-external-reviews=false" >> $GITHUB_OUTPUT

          # Documentation branches
          elif [[ "$BRANCH_NAME" =~ ^docs/ ]]; then
            echo "type=documentation" >> $GITHUB_OUTPUT
            echo "needs-lint=false" >> $GITHUB_OUTPUT
            echo "needs-test=false" >> $GITHUB_OUTPUT
            echo "needs-install=false" >> $GITHUB_OUTPUT
            echo "needs-external-reviews=false" >> $GITHUB_OUTPUT

          # CI/CD branches
          elif [[ "$BRANCH_NAME" =~ ^ci/ ]]; then
            echo "type=ci" >> $GITHUB_OUTPUT
            echo "needs-lint=true" >> $GITHUB_OUTPUT
            echo "needs-test=true" >> $GITHUB_OUTPUT
            echo "needs-install=true" >> $GITHUB_OUTPUT
            echo "needs-external-reviews=false" >> $GITHUB_OUTPUT

          # Bug fix branches
          elif [[ "$BRANCH_NAME" =~ ^fix/ ]]; then
            echo "type=fix" >> $GITHUB_OUTPUT
            echo "needs-lint=true" >> $GITHUB_OUTPUT
            echo "needs-test=true" >> $GITHUB_OUTPUT
            echo "needs-install=true" >> $GITHUB_OUTPUT
            echo "needs-external-reviews=false" >> $GITHUB_OUTPUT

          # Maintenance branches
          elif [[ "$BRANCH_NAME" =~ ^chore/ ]]; then
            echo "type=chore" >> $GITHUB_OUTPUT
            echo "needs-lint=true" >> $GITHUB_OUTPUT
            echo "needs-test=false" >> $GITHUB_OUTPUT
            echo "needs-install=false" >> $GITHUB_OUTPUT
            echo "needs-external-reviews=false" >> $GITHUB_OUTPUT

          # Release branches
          elif [[ "$BRANCH_NAME" =~ ^release/ ]]; then
            echo "type=release" >> $GITHUB_OUTPUT
            echo "needs-lint=true" >> $GITHUB_OUTPUT
            echo "needs-test=true" >> $GITHUB_OUTPUT
            echo "needs-install=true" >> $GITHUB_OUTPUT
            echo "needs-external-reviews=true" >> $GITHUB_OUTPUT

          # Main/develop branches
          elif [[ "$BRANCH_NAME" =~ ^(main|develop)$ ]]; then
            echo "type=main" >> $GITHUB_OUTPUT
            echo "needs-lint=true" >> $GITHUB_OUTPUT
            echo "needs-test=true" >> $GITHUB_OUTPUT
            echo "needs-install=true" >> $GITHUB_OUTPUT
            echo "needs-external-reviews=true" >> $GITHUB_OUTPUT

          # Default for unknown branches
          else
            echo "type=unknown" >> $GITHUB_OUTPUT
            echo "needs-lint=true" >> $GITHUB_OUTPUT
            echo "needs-test=true" >> $GITHUB_OUTPUT
            echo "needs-install=true" >> $GITHUB_OUTPUT
            echo "needs-external-reviews=true" >> $GITHUB_OUTPUT
          fi

      - name: Log detection results
        run: |
          echo "Detected branch type: ${{ steps.detect.outputs.type }}"
          echo "Needs lint: ${{ steps.detect.outputs.needs-lint }}"
          echo "Needs test: ${{ steps.detect.outputs.needs-test }}"
          echo "Needs install: ${{ steps.detect.outputs.needs-install }}"
          echo "Needs external reviews: ${{ steps.detect.outputs.needs-external-reviews }}"

  shell-tests:
    runs-on: ubuntu-latest
    needs: [detect-branch-type]
    if: needs.detect-branch-type.outputs.needs-test == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Bats
        run: |
          sudo npm install -g bats
          bats --version

      - name: Run shell tests
        run: |
          chmod +x tests/shell/run-shell-tests.sh
          ./tests/shell/run-shell-tests.sh

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: shell-test-results
          path: tests/shell/test-results/
          if-no-files-found: ignore

  template-validation:
    runs-on: ubuntu-latest
    needs: [detect-branch-type]
    if: needs.detect-branch-type.outputs.needs-test == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run template validation
        run: |
          chmod +x scripts/validate-templates.sh
          mkdir -p template-validation-results
          ./scripts/validate-templates.sh > template-validation-results/validation-output.txt 2>&1
          echo "Template validation exit code: $?" >> template-validation-results/validation-output.txt

      - name: Upload validation results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: template-validation-results
          path: template-validation-results/
          if-no-files-found: ignore

  comprehensive-validation:
    runs-on: ubuntu-latest
    needs: [detect-branch-type]
    if: needs.detect-branch-type.outputs.needs-test == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run comprehensive validation
        run: |
          chmod +x scripts/validate-all.sh
          mkdir -p validation-results
          ./scripts/validate-all.sh > validation-results/comprehensive-validation.txt 2>&1
          echo "Comprehensive validation exit code: $?" >> validation-results/comprehensive-validation.txt

      - name: Upload validation results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: comprehensive-validation-results
          path: validation-results/
          if-no-files-found: ignore

  project-index-generation:
    runs-on: ubuntu-latest
    needs: [detect-branch-type]
    if: needs.detect-branch-type.outputs.needs-test == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate project index
        run: |
          chmod +x scripts/generate-project-index.sh
          ./scripts/generate-project-index.sh

      - name: Upload project index
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: project-index
          path: project-index/
          if-no-files-found: ignore

  test:
    runs-on: ubuntu-latest
    needs: [detect-branch-type]
    if: needs.detect-branch-type.outputs.needs-test == 'true'
    strategy:
      matrix:
        test-type: [unit, integration, performance]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        if: matrix.test-type == 'unit'
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: "frontend/package-lock.json"

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.13"
          cache: "pip"
          cache-dependency-path: "backend/requirements.txt"

      - name: Install Python dependencies
        run: |
          pip install -r backend/requirements.txt

      - name: Set up test environment
        run: |
          # Create test database directory
          mkdir -p backend/instance
          # Set environment variables for testing
          echo "DATABASE_URL=sqlite:///backend/instance/test_pokehub.db" >> $GITHUB_ENV
          echo "FLASK_ENV=testing" >> $GITHUB_ENV
          echo "SECRET_KEY=test-secret-key" >> $GITHUB_ENV
          echo "JWT_SECRET_KEY=test-jwt-secret" >> $GITHUB_ENV

      - name: Initialize test database
        run: |
          # Initialize database tables for testing
          python -c "
          import os
          os.environ['DATABASE_URL'] = 'sqlite:///backend/instance/test_pokehub.db'
          os.environ['FLASK_ENV'] = 'testing'
          from backend.app import app
          from backend.database import db
          with app.app_context():
              db.create_all()
              print('‚úÖ Test database initialized')
          "

      - name: Install Node.js dependencies
        if: matrix.test-type == 'unit'
        run: |
          cd frontend && npm ci

      - name: Run tests
        run: |
          case ${{ matrix.test-type }} in
            unit)
              echo "Running unit tests..."
              cd frontend && npm run test:run
              cd .. && python -m pytest tests/unit/backend/ -v --rootdir=.
              ;;
            integration)
              echo "Running integration tests..."
              # Start backend for integration tests
              python -m backend.app &
              BACKEND_PID=$!
              sleep 10
              # Run integration tests
              python -m pytest tests/integration/legacy/ -v --rootdir=. || TEST_RESULT=$?
              # Stop backend
              kill $BACKEND_PID || true
              exit ${TEST_RESULT:-0}
              ;;
            performance)
              echo "Running performance tests..."
              # Start backend for performance tests
              python -m backend.app &
              BACKEND_PID=$!
              sleep 10
              # Run performance tests
              python -m pytest tests/performance/ -v --rootdir=. || TEST_RESULT=$?
              # Stop backend
              kill $BACKEND_PID || true
              exit ${TEST_RESULT:-0}
              ;;
          esac

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ matrix.test-type }}
          path: |
            frontend/test-results/
            backend/test-results/
            tests/test-results/
          if-no-files-found: ignore

  docker-test:
    runs-on: ubuntu-latest
    needs: [detect-branch-type, test]
    if: needs.detect-branch-type.outputs.needs-test == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Run Docker tests
        run: |
          cd tests/docker
          docker compose -f docker-compose.test.yml up --build -d
          sleep 30
          docker compose -f docker-compose.test.yml logs test-backend
          docker compose -f docker-compose.test.yml logs test-frontend
          docker compose -f docker-compose.test.yml down

      - name: Check test results
        run: |
          cd tests/docker

          # Run tests and capture exit code
          echo "Running Docker tests..."
          if docker compose -f docker-compose.test.yml up --build --abort-on-container-exit; then
            echo "‚úÖ All Docker tests passed!"
            DOCKER_EXIT_CODE=0
          else
            echo "‚ùå Docker tests failed!"
            DOCKER_EXIT_CODE=1
          fi

          # Clean up
          docker compose -f docker-compose.test.yml down

          # Exit with the test result
          exit $DOCKER_EXIT_CODE

  build:
    runs-on: ubuntu-latest
    needs: [detect-branch-type, test, docker-test]
    if: needs.detect-branch-type.outputs.needs-install == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker images
        run: |
          docker compose build

      - name: Test Docker build
        run: |
          docker compose up -d

          # Wait longer for container to be ready (healthcheck needs 40s)
          echo "‚è∞ Waiting 45 seconds for containers to be ready..."
          sleep 45

          # Show container logs for debugging
          echo "üìã Container logs:"
          docker compose logs pokehub-app || true

          # Test health endpoints
          echo "üîç Testing health endpoint..."
          curl -f http://localhost/ || exit 1

          # Clean up
          docker compose down
